# haconiwa アーキテクチャ設計

## はじめに

本ドキュメントは、AI協調開発支援CLIツール「haconiwa」のアーキテクチャ設計について記述します。haconiwaは、Python製CLIツールとして、AIエージェント（Boss/Worker/Manager）による協調開発を支援し、tmux区画管理、git-worktree連動、監視機能を統合します。

## システム全体構成

haconiwaは、複数のモジュールが連携して動作する分散システムを想定しています。主要なコンポーネントは以下の通りです。

-   **CLI**: ユーザーインターフェースとなるコマンドラインツール。Typerフレームワークを使用。
-   **Core**: システムの基盤となる設定、状態、ログ、アップグレード管理。
-   **World**: 開発環境（ローカル、Docker、LXCなど）を抽象化し管理。
-   **Space**: tmuxを利用した開発作業空間の管理。
-   **Resource**: ファイルシステムやデータベースなどのリソースへのアクセス管理。
-   **Agent**: AIエージェント（Boss, Worker, Manager）の実装と管理。
-   **Task**: git-worktreeを利用した開発タスクの管理。
-   **Watch**: システムやエージェントの監視、メトリクス収集、アラート。
-   **Utils**: 各モジュールで共通利用されるユーティリティ機能。

これらのモジュールは、Coreモジュールを介して設定や状態を共有し、CLIを通じて操作されます。

## 7層アーキテクチャ

haconiwaのアーキテクチャは、以下の7つの主要な層（モジュール）で構成されます。

1.  **Core**: システムの核。設定、状態、ログ、アップグレードを管理。
2.  **World**: 開発環境（仮想環境、コンテナなど）を管理。プロバイダーパターンで抽象化。
3.  **Space**: 作業空間（tmuxセッション/ペイン）を管理。
4.  **Resource**: 開発に必要なリソース（コード、データなど）へのアクセスを提供。
5.  **Agent**: AIエージェントのロジックとライフサイクルを管理。
6.  **Task**: 開発タスクとそれに対応するgit-worktreeを管理。
7.  **Watch**: システム全体の監視とメトリクス収集。

これらの層は、下位層が上位層にサービスを提供する形で依存関係を持ちます。例えば、AgentはTaskやResourceを利用し、TaskやResourceはWorldやSpaceのコンテキストで実行されます。Coreは全ての層から参照される基盤となります。

## AIエージェント協調メカニズム (Boss-Worker-Manager パターン)

haconiwaの中心的な機能は、AIエージェントによる協調開発です。以下の3種類のエージェントが連携します。

-   **Boss Agent**: 全体計画、タスク分解、Workerへのタスク割り当て、進捗管理、品質レビューを担当します。プロジェクト全体の目標達成を指揮します。
-   **Worker Agent**: Bossから割り当てられた特定のタスク（コーディング、テスト、ドキュメント作成など）を実行します。専門分野（フロントエンド、バックエンド、QAなど）に特化できます。
-   **Manager Agent**: エージェント間の調整、リソース競合の解決、全体最適化、コミュニケーション促進を担当します。円滑な開発フローを支援します。

エージェント間の通信は、メッセージキューや共有状態を通じて非同期に行われることを想定しています。BaseAgentクラスが共通インターフェースとライフサイクルを提供します。

## 主要機能連携設計

### tmux区画管理とSpaceモジュール

Spaceモジュールは、`tmux`コマンドをPythonから操作することで、開発作業用のセッション、ウィンドウ、ペインを動的に管理します。これにより、エージェントやユーザーは、タスクごとに分離された作業空間で並行して作業できます。各ペインは特定のタスクやエージェントに割り当てられ、コマンド実行やログ表示に使用されます。

### git-worktree連動とTaskモジュール

Taskモジュールは、`git worktree`コマンドをPythonから操作することで、開発タスクごとに独立した作業ディレクトリ（worktree）を作成・管理します。各worktreeは特定のタスクブランチに対応し、エージェントは他のタスクに影響を与えることなく、自身のworktree内でコード変更、コミット、プッシュなどのGit操作を行います。タスク完了時にはworktreeの清理を行います。

## 分散実行アーキテクチャ

haconiwaは、複数の「World」（開発環境）を同時に管理し、それぞれ異なるプロジェクトやタスクを並列で開発することを想定しています。各Worldは完全に分離された環境（ローカルディレクトリ、Dockerコンテナ、LXCコンテナなど）であり、独自のSpace、Agent、Task、Resourceインスタンスを持ちます。Coreモジュールは、これらのWorldの状態を一元管理し、World間の連携やリソース共有のメカニズムを提供します。

## セキュリティ設計

各Worldは、プロバイダーの機能（Docker/LXCのnamespace分離、ローカル環境の権限管理）を利用して互いに分離されます。エージェントの実行権限は最小限に制限され、機密情報へのアクセスは厳密に制御されます。設定ファイルや状態ファイルは、必要に応じて暗号化やアクセス制御が適用されます。

## 拡張性設計

haconiwaは、プラグインシステムとカスタムプロバイダーを通じて拡張可能です。

-   **World Provider**: 新しい仮想化技術（Kubernetes, Vagrantなど）に対応するためのプロバイダーを追加できます。
-   **Resource Provider**: 新しいデータソース（外部API、クラウドストレージなど）に対応するためのプロバイダーを追加できます。
-   **Agent**: 特定の専門分野に特化した新しいWorkerエージェントを開発・追加できます。
-   **Task Strategy**: 新しいタスク管理ワークフローやGit操作戦略を実装できます。
-   **Watch Integration**: 新しい監視システムや通知サービスと連携できます。

これらの拡張は、定義されたインターフェースに従ってPythonモジュールとして実装され、Coreモジュールに登録されることで利用可能になります。

## Pythonクラス設計とインターフェース定義

各モジュールは、責務に応じたクラス群で構成されます。主要なクラスは抽象基底クラス（ABC）としてインターフェースを定義し、具体的な実装はサブクラスで行います。例えば、`agent.base.BaseAgent`、`world.provider.BaseProvider`などがこれにあたります。依存性の注入やファクトリパターンを活用し、モジュール間の結合度を低く保ちます。非同期処理にはPythonの`asyncio`を活用し、並行処理には`threading`や`multiprocessing`を適切に使い分けます。